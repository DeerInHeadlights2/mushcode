@@ DEPENDENCIES - Core
@@ +banlist does not work AT ALL on RhostMUSH.
@@ +ip cannot track failed logins on RhostMUSH.
@@ +ip and +banlist requires MySQL.

th u(NEWCOBJ,Account Management System <AMS>,ams,,,,WIZARD SAFE !NO_COMMAND,INHERIT SIDEFX SAFE)
@power [u(cobj,ams)]=no_pay debit queue
th u(NEWCOBJ,Account Database <ACCOUNTS>,accounts,u(cobj,ams),,,WIZARD SAFE,SIDEFX SAFE)

&IDLE_SECS [u(cobj,accounts)]=1800
&TIMEZONE [u(cobj,accounts)]=UTC

@attach %!/WIPE=u(cobj,ams),STARTUP

&ACONNECT`SUITE`MAIL [u(cobj,ancestor_player)]=@stop u(isguest,%@);@check u(op,MAIL);+mailcheck

&CMD`MAILCHECK [u(cobj,ams)]=$+mailcheck:@attach %!/INC`CHECKPC=%#,1;@select/inline t(words(u(setr,ualts,u(FILTER,UMAIL,u(alts,%q<t1>)))))=1,{@pemit %0=ansi(hy,Unread Mail(s) by Character(s):) [iter(u(sortname,%q<ualts>),ansi(h,name(%i0)) ([u(umail,%i0)]),%b,\,%b)]},0,{@pemit %0=ansi(hy,You have no unread mail.)}
&FIL`UMAIL [u(cobj,pcs)]=t(u(umail,%0))

&SYSTEM`SWITCHES [u(cobj,ams)]=setunion(setunion(setunion(u(SWITCHES`%q<sysname>`PLAYER),if(u(isadmin,%#),u(SWITCHES`%q<sysname>`ADMIN)),|,|),if(cor(u(OPEN_CREATION),u(conf,OPEN_ACCOUNT)),v(SWITCHES`%q<sysname>`OPEN_CREATION)),|,|),if(u(iswizard,%#),u(SWITCHES`%q<sysname>`WIZARD)),|,|)
&SYSTEM`NAME [u(cobj,ams)]=u(strfirstof,%q<sysname>,ACCOUNT)

@@ CONFIG SECTION
&CONFIG`OPTIONS [u(cobj,ams)]=AUTO_ACCOUNT|RECORD_LOGINS|CHANNELS_PLAYERS|OPEN_ACCOUNT|ACCOUNT_RENAME|WIZLIST_FOOTER|APPROVE_CHANNELS|UNAPPROVE_CHANNELS|WHO_HEADER|WHO_COLUMNS|WHERE_HEADER|WHERE_COLUMNS|GUEST_HOME|CHANNELS_GUESTS

&CONFIG`AUTO_ACCOUNT [u(cobj,ams)]=Attempt to auto-bind accounts based on IP? Requires RECORD_LOGINS to be True.
&CONFIG`AUTO_ACCOUNT`DEFAULT [u(cobj,ams)]=1
&CONFIG`AUTO_ACCOUNT`VALID [u(cobj,ams)]=BOOL

&CONFIG`RECORD_LOGINS [u(cobj,ams)]=Enable the login tracker. Records login times and IP addresses for all connections.
&CONFIG`RECORD_LOGINS`DEFAULT [u(cobj,ams)]=1
&CONFIG`RECORD_LOGINS`VALID [u(cobj,ams)]=BOOL

&CONFIG`CHANNELS_PLAYERS [u(cobj,ams)]=Players will be added to these Channels on Create.
&CONFIG`CHANNELS_PLAYERS`DEFAULT [u(cobj,ams)]=
&CONFIG`CHANNELS_PLAYERS`VALID [u(cobj,ams)]=LIST

&CONFIG`OPEN_ACCOUNT [u(cobj,ams)]=Players can create and manage their own accounts?
&CONFIG`OPEN_ACCOUNT`DEFAULT [u(cobj,ams)]=1
&CONFIG`OPEN_ACCOUNT`VALID [u(cobj,ams)]=BOOL

&CONFIG`ACCOUNT_RENAME [u(cobj,ams)]=Players can rename their own accounts?
&CONFIG`ACCOUNT_RENAME`DEFAULT [u(cobj,ams)]=1
&CONFIG`ACCOUNT_RENAME`VALID [u(cobj,ams)]=BOOL

&CONFIG`WIZLIST_FOOTER [u(cobj,ams)]=This message is displayed at the bottom of the +admin aka wizlist command.
&CONFIG`WIZLIST_FOOTER`DEFAULT [u(cobj,ams)]=
&CONFIG`WIZLIST_FOOTER`VALID [u(cobj,ams)]=WORD

&CONFIG`CHANNELS_GUESTS [u(cobj,ams)]=Guests will be added to these Channels.
&CONFIG`CHANNELS_GUESTS`DEFAULT [u(cobj,ams)]=
&CONFIG`CHANNELS_GUESTS`VALID [u(cobj,ams)]=LIST

@@ ****** ACCOUNT SECTION *******
&CMD`+ACCOUNT`PENNMUSH [u(cobj,ams)]=$^(?\:\+)?account(?\:/(\S+)?)?(?\: +(.+?))?(?\:=(.*))?$:@attach %!/CMD`+ACCOUNT`MAIN
@set [u(cobj,ams)]/CMD`+ACCOUNT`PENNMUSH=regexp
&CMD`+ACCOUNT`RHOSTMUSH [u(cobj,ams)]=$^(?\:\+)?account(?\:/(\\S+)?)?(?\: +(.+?))?(?\:=(.*))?$:@attach %!/CMD`+ACCOUNT`MAIN
@set [u(cobj,ams)]/CMD`+ACCOUNT`RHOSTMUSH=regexp
&CMD`+ACCOUNT`MAIN [u(cobj,ams)]=th u(setq,sysname,ACCOUNT);@attach %!/INC`GETSWITCH=%1;@attach %!/INC`ACCOUNT`[u(strfirstof,%q<switch>,MAIN)]=%2,%3
@set [u(cobj,ams)]/CMD`+ACCOUNT`[u(choosegame,RHOSTMUSH,PENNMUSH)]=no_command

&SWITCHES`ACCOUNT`PLAYER [u(cobj,ams)]=
&SWITCHES`ACCOUNT`ADMIN [u(cobj,ams)]=BIND|UNBIND|UNBOUND|CREATE|LIST|RENAME|INACTIVE|CONFIG
&SWITCHES`ACCOUNT`WIZARD [u(cobj,ams)]=ENABLE|DISABLE
&SWITCHES`ACCOUNT`OPEN_CREATION [u(cobj,ams)]=REQUEST|ACCEPT|NEW|RENAME

&INC`ACCOUNT`CONFIG [u(cobj,ams)]=@attach %!/INC`CONFIG

&INC`ACCOUNT`FIND [u(cobj,ams)]=@check strlen(%0)=@attach %!/INC`MSG=ERROR: Account Name field empty.;@check strlen(u(setr,accid,namegraball(children(u(cobj,accounts)),%0)))=@attach %!/INC`MSG=ERROR: Account '%0' not found.;@stop gt(words(%q<accid>),1)=@attach %!/INC`MSG=ERROR: '%0' matched multiple accounts. Please be more specific.;th u(setq,accname,name(%q<accid>))

&INC`ACCOUNT`TARGET [u(cobj,ams)]=@select/inline %0=#*,{@attach %!/INC`ACCOUNT`FIND=after(%0,#)},{@attach %!/INC`CHECKPC=%0,1;@check isdbref(%q<t1acc>)=@attach %!/INC`MSG=ERROR: %q<t1name> is not bound to an account.;th u(setq,accid,%q<t1acc>);th u(setq,accname,name(%q<accid>))}

&INC`ACCOUNT`MAIN [u(cobj,ams)]=@select/inline cand(u(isadmin,%#),strlen(%0))=1,{@attach %!/INC`ACCOUNT`TARGET},0,{@check isdbref(u(setr,accid,get(%#/D`ACCOUNT)))=@attach %!/INC`MSG=ERROR: No account to display.;th u(setq,accname,name(%q<accid>))};@attach %!/INC`ACCOUNT`SHOW

&INC`ACCOUNT`CREATE [u(cobj,ams)]=@attach %!/INC`VALID`EMAIL=%0;@stop isdbref(u(find_in,u(cobj,accounts),%q<value>))=@attach %!/INC`MSG=ERROR: An account already exists with that name.;@check valid(name,%q<value>)=@attach %!/INC`MSG=ERROR: That name can't be used for an account.;@tel [u(setr,accid,objid(create(u(setr,accname,%q<value>))))]=u(cobj,accounts);@parent %q<accid>=u(cobj,accounts);th u(attrib_set,%q<accid>,D`ACCOUNT,%q<accid>);th u(attrib_set,%q<accid>,D`ACCOUNT`ID,u(call`2,volp_account,0,'[sqlescape(%q<accid>)]','[sqlescape(%q<accname>)]'));@attach %!/INC`MSG`CHAN={Created NEW ACCOUNT: %q<accname>}

&INC`ACCOUNT`NEW [u(cobj,ams)]=@stop u(isguest,%#)=@attach %!/INC`MSG=ERROR: Permission denied.;@stop strmatch(%#,#1)=@attach %!/INC`MSG=ERROR: #1 cannot be bound to an Account.;@stop isdbref(u(setr,accid,u(accid,%#,1)))=@attach %!/INC`MSG=ERROR: You are already bound to [name(%q<accid>)]!;@attach %!/INC`ACCOUNT`CREATE;@attach %!/INC`ACCOUNT`ADDTOACCOUNT=%q<accid>,%:;@attach %!/INC`MSG={You are now bound to ACCOUNT: %q<accname>!};@attach %!/INC`MSG`CHAN={Bound to NEW ACCOUNT: %q<accname> via +account/new}

&INC`ACCOUNT`LIST [u(cobj,ams)]=@check t(u(setr,count,u(mysql,COUNT`ACTIVE_ACCOUNTS,0)))=@attach %!/INC`MSG=ERROR: There are no active accounts entered in the system.;@attach %!/INC`ACCOUNT`MAINLIST=Accounts,0

&Q`COUNT`ACTIVE_ACCOUNTS [u(cobj,ams)]=SELECT count(account_id) FROM volv_account_characters WHERE old_characters=?

&INC`ACCOUNT`INACTIVE [u(cobj,ams)]=@check t(u(setr,count,u(mysql,COUNT`ACTIVE_ACCOUNTS,1)))=@attach %!/INC`MSG=ERROR: There are no inactive accounts to list.;@attach %!/INC`ACCOUNT`MAINLIST=Inactive Accounts,1

&INC`ACCOUNT`MAINLIST [u(cobj,ams)]=@pemit %#=u(header,mudname() %0);@pemit %#=ansi(u(color,%#,COLUMN_NAMES),align(30 6 42,Name,Last,Characters));@pemit %#=u(separator);@dolist lnum(1,u(setr,pages,add(div(%q<count>,30),1)))={th u(setq,accounts,u(mysql3,SELECT`ACCOUNTS,%1,mul(sub(u(setr,page,u(choosegame,%i0,%d0)),1),30)));@dolist/inline/delimit [chr(176)] %q<accounts>={th u(setq,data,u(choosegame,%i0,%d0));@pemit %#=align(30 6 42,u(pueblize,u(setr,name,name(elements(%q<data>,3,chr(177)))),+account #%q<name>),if(u(setr,last,elements(%q<data>,6,chr(177))),elements(u(fancytime,%q<last>,%#),1 2),ansi(hx,N/A)),if(%1,OLD: [iter(elements(%q<data>,9,chr(177)),%i0,|,\,%b)],iter(elements(%q<data>,10,chr(177)),u(pueblize,u(moniker,%i0),+finger [name(%i0)]),%b,\,%b)))};@select/inline %q<page>=%q<pages>,{@pemit %#=u(footer,+account <id or player> for details)}}

&Q`SELECT`ACCOUNTS [u(cobj,ams)]=SELECT * FROM volv_account_characters WHERE old_characters=0 LIMIT 30 OFFSET ?

&FUN`ACCOUNT`CHARLINE [u(cobj,ams)]=align(-6 3 -2 -3 -4 21 -4 21 6,num(%0),switch(1,u(iswizard,%0),ansi(u(conf,WIZTAG),WIZ),hasflag(%0,ROYALTY),ansi(u(conf,ROYTAG),ROY),u(isadmin,%0),ansi(hy,ADM),haspower(%0,BUILDER),ansi(hm,BUI),u(isapproved,%0),ansi(hg,APP),ansi(hr,---)),default(%0/D`ALTS,0),u(getproperty,%0,MAJORABBR),default(%0/D`FINGER`TYPE,??),u(pueblize,u(moniker,%0),+finger [name(%0)]),elements(maildstats(%0),5),if(get(%0/D`APPROVED),u(fancytime,get(%0/D`APPROVED),%#),N/A),u(lastidle,%0))

&INC`ACCOUNT`SHOW [u(cobj,ams)]=th u(setq,pcs,u(sortname,children(%q<accid>)));@pemit %#=u(HEADER,ACCOUNT: [name(%q<accid>)]);@pemit %#=ansi(u(color,%#,COLOR,COLUMN_NAMES),align(-6 3 2 3 4 21 4 21 6,Dbref,Sta,Al,Fac,Type,Name,Mail,Date Approved,LastOn));@pemit %#=u(SEPARATOR);@dolist/inline %q<pcs>={@pemit %#=u(FUN`ACCOUNT`CHARLINE,##)};@select/inline cand(u(player_config,%#,SYSTEM,OLD_ALTS),gt(words(u(setr,old,u(filter,OLDOBJID,get(%q<accid>/OLD),|,|)),|),0))=1,{@pemit %#=u(SEPARATOR,Old Characters);@pemit %#=align(-6 3 3 21 8 21,Dbref,,,Name,,Objid);@dolist/inline/delimit | [u(sortoldid,%q<old>,|,|)]={@pemit %#=align(-6 3 -3 21 8 21,before(##,:),,,after(##,~),,before(##,~))}};@pemit %#=u(footer)

&INC`ACCOUNT`REQUEST [u(cobj,ams)]=@stop isdbref(u(setr,accid,u(accid,%#,1)))=@attach %!/INC`MSG=ERROR: You already belong to [name(%q<accid>)]!;@attach %!/INC`CHECKPC=%0,1;@check u(setr,reqacc,u(accid,%q<t1>,1))=@attach %!/INC`MSG=ERROR: %q<t1name> does not have an account!;@attach %!/INC`MSG=Request sent! Please use +request/accept %n on any character for that account to confirm.;th u(attrib_set,%q<reqacc>,REQUESTS,setunion(get(%q<reqacc>/REQUESTS),%:));@attach %!/INC`MSG=%n has requested to join this account. Use [u(pueblize,+account/accept %n)] to confirm.,u(alts,%q<t1>);@attach %!/INC`MSG`CHAN=Sent add request to [name(%q<reqacc>)].

&INC`ACCOUNT`ACCEPT [u(cobj,ams)]=@check isdbref(u(setr,accid,u(accid,%#,1)))=@attach %!/INC`MSG=ERROR: You do not have an account!;@attach %!/INC`CHECKPC=%0,1;@stop u(setr,reqacc,u(accid,%q<t1>,1))=@attach %!/INC`MSG=ERROR: %q<t1name> already has an account!;@check match(get(%q<accid>/REQUESTS),%q<t1objid>)=@attach %!/INC`MSG=ERROR: No request pending from %q<t1name>.;th u(attrib_set,%q<accid>,REQUESTS,setdiff(get(%q<accid>/REQUESTS),%q<t1objid>));@attach %!/INC`MSG=%q<t2name> has been added to [name(%q<accid>)],u(alts,%#);@attach %!/INC`MSG`CHAN=Account request for %q<t1name> to [name(%q<accid>)] confirmed.;@attach %!/INC`ACCOUNT`ADDTOACCOUNT=%q<accid>,%q<t1objid>

&INC`ACCOUNT`BIND [u(cobj,ams)]=@attach %!/INC`CHECKPC=%0,2;@stop strmatch(%q<t2>,#1)=@attach %!/INC`MSG=ERROR: #1 cannot be bound to an Account.;@select/inline %1=NEW,{@attach %!/INC`ACCOUNT`CREATE=%q<t2name>},{@attach %!/INC`ACCOUNT`TARGET=%1};@select/inline isdbref(%q<t2acc>)=1,{@attach %!/INC`ACCOUNT`REMFROMACCOUNT=%q<t2acc>,%q<t2objid>};@attach %!/INC`ACCOUNT`ADDTOACCOUNT=%q<accid>,%q<t2objid>;@attach %!/INC`MSG`NOTICE=You have been Account-Bound to [u(pueblize,%q<accname>,+account)].,%q<t2>;@attach %!/INC`MSG=You have Bound %q<t2name> to [u(pueblize,name(%q<accid>),+account [last(name(%q<accid>))])];@attach %!/INC`MSG`CHAN=Account-Bound %q<t2name> to [u(pueblize,%q<accname>,+account #%q<accname>)]

&INC`ACCOUNT`ADDTOACCOUNT [u(cobj,ams)]=@parent %1=%0;@attach %!/INC`DOSQL=SET`ACCOUNT_ID,get(%1/D`ACCOUNT`ID),get(%1/D`ID);

&Q`SET`ACCOUNT_ID [u(cobj,ams)]=UPDATE vol_character SET account_id=? WHERE character_id=?

&INC`ACCOUNT`REMFROMACCOUNT [u(cobj,ams)]=@parent %1;@attach %!/INC`DOSQL=CLEAN`LOGIN_LOGS,get(%1/D`ID);@attach %!/INC`DOSQL=CLEAN`ACCOUNT_ID,get(%1/D`ID);@attach %!/INC`ACCOUNT`REMFROMACCOUNT`EXTRA

&Q`CLEAN`LOGIN_LOGS [u(cobj,ams)]=DELETE FROM vol_login WHERE character_id=?
&Q`CLEAN`ACCOUNT_ID [u(cobj,ams)]=UPDATE vol_character SET account_id=NULL WHERE character_id=?

&INC`ACCOUNT`UNBIND [u(cobj,ams)]=@attach %!/INC`CHECKPC=%0,1;@check u(setr,accid,%q<t1acc>)=@attach %!/INC`MSG={ERROR: %q<t1name> is not a member of any accounts.};@attach %!/INC`ACCOUNT`REMFROMACCOUNT=%q<accid>,%q<t1objid>;@attach %!/INC`MSG={You have removed %q<t1name> from Account [name(%q<accid>)]};@attach %!/INC`MSG`NOTICE={You were removed from Account '[name(%q<accid>)]'},%q<t1>;@attach %!/INC`MSG`CHAN={Removed %q<t1name> from [name(%q<accid>)]}

&INC`ACCOUNT`UNBOUND [u(cobj,ams)]=@check words(u(setr,unbound,switch(%va,PennMUSH,lsearch(all,type,player,elock,!D`ACCOUNT:?*),search(eplayer=!hasattr(##,D`ACCOUNT)))))=@attach %!/INC`MSG={There are no accountless PCs in the Database. Hooray!};@pemit %#=u(HEADER,Unbound Characters);@pemit %#=align(-6 3 3 27 25 9,Dbref,Sta,Alt,Name,IP,Last On);@pemit %#=u(SEPARATOR);@dolist/inline %q<unbound>={@pemit %#=u(FUN`ACCOUNT`CHARLINE,##)};@pemit %#=u(FOOTER)

&INC`ACCOUNT`RENAME [u(cobj,ams)]=@select/inline cand(not(u(isadmin,%#)),cor(u(OPEN_CREATION),u(conf,ACCOUNT_RENAME)))=1,{@check isdbref(u(setr,accid,u(accid,%#,1)))=@pemit %#=ERROR: This character is not bound to an Account.;@attach %!/INC`ACCOUNT`CHECKRENAME;@name %q<accid>=%q<value>;@attach %!/INC`MSG=Account name changed to: %q<value>.;@attach %!/INC`MSG`CHAN=Changed Account email to: %q<value>},{@check u(isadmin,%#)=@attach %!/INC`MSG={Only Staff may rename accounts!};@attach %!/INC`ACCOUNT`TARGET=%0;@attach %!/INC`ACCOUNT`CHECKRENAME=%1;@name %q<accid>=%q<value>;@attach %!/INC`MSG=Account renamed to: %q<value>.;@attach %!/INC`MSG`CHAN=Renamed Account '%q<accname>' to: %q<value>}

&INC`ACCOUNT`CHECKRENAME [u(cobj,ams)]=@attach %!/INC`VALID`EMAIL=%0;@check valid(name,%q<value>)=@attach %!/INC`MSG=ERROR: That is not a good name for an account.;@stop cand(isdbref(u(setr,found,u(find_in,u(cobj,accounts),%q<value>))),not(strmatch(before(%q<accid>,:),before(%q<found>,:))))=@attach %!/INC`MSG=ERROR: An account already has that name/email. They must be unique.

&INC`ACCOUNT`DISABLE [u(cobj,ams)]=@check strlen(%0)=@attach %!/INC`MSG={ERROR: Account ID empty.};@attach %!/INC`ACCOUNT`FIND=%0;@stop u(lmax,iter(u(setr,chars,get(%q<accid>/CHARACTERS)),u(isadmin,%i0)))=@attach %!/INC`MSG=ERROR: Cannot disable an account that contains an admin character. Demote them first.;@attach %!/INC`VERIFY={ansi(hr,WARNING:) This will disable Account %q<accname>. Bound characters will not be able to login. Are you sure? Enter the command again within ten seconds to continue.},ACCOUNT DISABLE %q<accid>;@attach %!/INC`MSG={[name(%q<accid>)] disabled!};@attach %!/INC`MSG`NOTICE={Your account was disabled.},u(setr,chars,get(%q<accid>/CHARACTERS));@attach %!/INC`MSG`CHAN={[name(%q<accid>)] disabled!};@attach %!/INC`DOSQL=ACCOUNT`TOGGLE,0,%q<accid>;th u(attrib_set,%q<accid>,D`DISABLED,1);@dolist/inline %q<chars>={@boot ##};

&Q`ACCOUNT`TOGGLE [u(cobj,ams)]=UPDATE vol_account SET account_disabled=? WHERE account_id=?

&INC`ACCOUNT`ENABLE [u(cobj,ams)]=@check strlen(%0)=@attach %!/INC`MSG={ERROR: Account ID empty.};@attach %!/INC`ACCOUNT`FIND=%0;@attach %!/INC`MSG={[name(%q<accid>)] enabled!};@attach %!/INC`MSG`NOTICE={Your account was enabled.},u(setr,chars,get(%q<accid>/CHARACTERS));@attach %!/INC`MSG`CHAN={[name(%q<accid>)] enabled!};@attach %!/INC`DOSQL=ACCOUNT`TOGGLE,1,%q<accid>;@attach %!/WIPE=%q<accid>,D`DISABLED

&PLAYER`CONNECT [u(cobj,ams)]=@dolist/inline u(lattr,%!/PLAYER`CONNECT`*)={@trigger %!/##=%0,%1,%2,%3,%4,%5,%6,%7,%8,%9}
&PLAYER`CREATE [u(cobj,ams)]=@dolist/inline u(lattr,%!/PLAYER`CREATE`*)={@trigger %!/##=%0,%1,%2,%3,%4,%5,%6,%7,%8,%9}
&PLAYER`DISCONNECT [u(cobj,ams)]=@dolist/inline u(lattr,%!/PLAYER`DISCONNECT`*)={@trigger %!/##=%0,%1,%2,%3,%4,%5,%6,%7,%8,%9}

&OBJECT`RENAME [u(cobj,ams)]=@dolist/inline u(lattr,%!/OBJECT`RENAME`*)={@trigger %!/##=%0,%1,%2,%3,%4,%5,%6,%7,%8,%9}
&OBJECT`DESTROY [u(cobj,ams)]=@dolist/inline u(lattr,%!/OBJECT`DESTROY`*)={@trigger %!/##=%0,%1,%2,%3,%4,%5,%6,%7,%8,%9}
&OBJECT`CREATE [u(cobj,ams)]=@dolist/inline u(lattr,%!/OBJECT`CREATE`*)={@trigger %!/##=%0,%1,%2,%3,%4,%5,%6,%7,%8,%9}
&OBJECT`MOVE [u(cobj,ams)]=@dolist/inline u(lattr,%!/OBJECT`MOVE`*)={@trigger %!/##=%0,%1,%2,%3,%4,%5,%6,%7,%8,%9}

&OBJECT`RENAME`ENTITY_NAME [u(cobj,ams)]=u(mysql,ENTITY`RENAME,%1,%0)
&Q`ENTITY`RENAME [u(cobj,ams)]=UPDATE vol_entity SET entity_name=? WHERE entity_objid=?

&PLAYER`CREATE`ID [u(cobj,ams)]=th u(attrib_set,%0,D`ID,u(call`4,volp_character,0,'%0','[sqlescape(%1)]',u(csecs,%0),u(isguest,%0)));
&PLAYER`CONNECT`ID [u(cobj,ams)]=th u(attrib_set,%0,D`ID,u(call`4,volp_character,0,'%0','[sqlescape(name(%0))]',u(csecs,%0),u(isguest,%0)));

&PLAYER`CONNECT`DISABLED [u(cobj,ams)]=@select/inline cand(isobjid(u(setr,acc,u(accid,%0))),get(%q<acc>/D`DISABLED),not(u(isadmin,%0)))=1,{@attach %!/INC`MSG=Login denied! Your account is disabled.,%0;@boot %0}

&PLAYER`CONNECT`ACCOUNT [u(cobj,ams)]=@stop cor(u(isguest,%0),strmatch(num(%0),#1));@attach %!/INC`CHECKPC=%0,1;@stop isdbref(%q<t1acc>)=&LAST %q<t1acc>=secs();@select/inline u(conf,AUTO_ACCOUNT)=1,{@select/inline words(u(setr,accid,trim(u(mysql,GET`ACCOUNTS,get(%0/LASTIP)))))=>1,{@attach %!/INC`MSG=Welcome to [mudname()]! Login records show multiple accounts for this site. Auto-Matching cannot continue. [if(u(open_creation),%BPlease use +account/request on an existing alt if you have one. Else\, you may +account/new to generate a new account.,%BPlease request an account from staff.)],%0},1,{@attach %!/INC`MSG=Welcome to [mudname()]! We found one account matching your login records. You have been auto-bound to [name(%q<accid>)]! Please contact staff if this is in error.,%0;@attach %!/INC`ACCOUNT`ADDTOACCOUNT=%q<accid>,%0},0,{@attach %!/INC`MSG=Welcome to [mudname()]! No account was found for this character.[if(u(open_creation),%BPlease use +account/request on an existing alt if you have one. Else\, you may +account/new to generate a new account.,%BPlease request an account from staff.)],%0}},0,{@attach %!/INC`MSG=Welcome to [mudname())]! No account was found for this character.[if(u(open_creation),%BPlease use +account/request on an existing alt if you have one. Else\, you may +account/new to generate a new account.,%BPlease request an account from staff.)],%0}

&Q`GET`ACCOUNTS [u(cobj,ams)]=SELECT DISTINCT account_objid FROM volv_login WHERE character_is_guest=0 AND character_is_guest=0 AND ip_address=?

&PLAYER`DISCONNECT`ACCOUNT [u(cobj,ams)]=@attach %!/INC`CHECKPC=%0,1;&LAST %q<t1acc>=secs();@attach %!/INC`DOSQL=UPDATE`ACCOUNT_LAST,%q<t1accid>;@attach %!/INC`DOSQL=UPDATE`CHARACTER_LAST,%q<t1id>

&Q`UPDATE`ACCOUNT_LAST [u(cobj,ams)]=UPDATE vol_account SET account_date_activity=UTC_TIMESTAMP() WHERE account_id=?

&Q`UPDATE`CHARACTER_LAST [u(cobj,ams)]=UPDATE vol_character SET character_date_activity=UTC_TIMESTAMP() WHERE character_id=?

&START`ACCOUNTCHECK [u(cobj,ams)]=@trigger %!/LOOP`ACCOUNTCHECK

&LOOP`ACCOUNTCHECK [u(cobj,ams)]=@dolist/inline/nobreak u(lwhoid)={@select/inline [isdbref(get(##/D`ACCOUNT))][strmatch(name(get(##/D`ACCOUNT)),*@*.*)]=0*,{@select/inline t(u(conf,OPEN_ACCOUNT))=1,{@attach %!/INC`MSG=[ansi(hr,WARNING:)] This Character has no Account! This is not supported. Please use [ansi(hw,+account/new <email>)] to register an account. If you already have an account then use +account/request <alt> to begin the registration process.,##},0,{@attach %!/INC`MSG=[ansi(hr,WARNING:)] This Character has no Account! This is not supported. Please contact staff with your email or existing alt/account name to be bound to an account.}},10,{@select/inline t(u(conf,ACCOUNT_RENAME))=1,{@attach %!/INC`MSG=[ansi(hr,WARNING:)] Your Account does not follow the new naming Guidelines. Please use [ansi(hw,+account/rename <email>)] to fix this. Non-Email addresses may not be eligible for password resets or future database migration.},0,{@attach %!/INC`MSG=[ansi(hr,WARNING:)] Your Account does not follow the new naming Guidelines. Please ask staff to rename your account to an Email Address. Non-Email addresses may not be eligible for password resets or future database migration.}}};@wait 1200=@trigger %!/LOOP`ACCOUNTCHECK

&PLAYER`CREATE`CHANNELS [u(cobj,ams)]=@select/inline %va=PennMUSH,{@dolist/inline/delimit | [u(conf,CHANNELS_PLAYERS)]={@channel/on %i0=%0}},RhostMUSH,{}

&HLP`+ACCOUNT [u(cobj,ams)]=The account system tracks players (and their alts) and their current status in the game (unapproved, approved, builder, admin, etc.).%R%R[ansi(hc,Player Commands)]%R[align(5 [sub(u(width,%#),6)],,[ansi(h,+account)] - Shows your account if you have one.%R[ansi(h,+account/new <name>)] - For new players. Enter this to start a new account on our game. You should preferably use your email address!%R[if(u(conf,OPEN_CREATION),[ansi(h,+account/rename <newname>)] - Renames your account.%R)][ansi(h,@password <old>=<new>)] - Change your password. If you forget your password\, staff will send a new one to your <email> on request - or if your Guest IP matches your previous logins.)]
+help/add Character/+account=[u(cobj,ams)]/HLP`+ACCOUNT

&SHLP`+ACCOUNT [u(cobj,ams)]=[ansi(hc,Staff Commands)]%R[align(5 [sub(u(width,%#),6)],,[ansi(h,+account/list)] - Shows all accounts in the system.%R[ansi(h,+account/inactive)] - List inactive accounts.%R[ansi(h,+account <account>)] - Shows a specific account. Target can be a player\, OR an account name preceded by # such as #MushDude.%R[ansi(h,+account/create <name>)] - Create a new account.%R[ansi(h,+account/rename <account>=<newname>)] - Target as with +account. Renames account to <newname>.%R[ansi(h,+account/bind <player>=<account>)] - Binds <player> to an account\, removing them from any other account they're in. <account> can be the name of an character \(if they have an account\)\, the word NEW \(makes a new account using the character's name\)\, or the name of an account preceded by # - such as #MushDude.%R[ansi(h,+account/unbind <player>)] - Removes a player from any account they're in.%R[ansi(h,+account/unbound)] - Displays all unbound characters. Some are best left that way.%R[ansi(h,@newpass *<name>=<newpassword>)] - Set a new password for <name>. Note the asterisk\, this is necessary! This command is WIZARD only.)]
+shelp/add Character/+account=[u(cobj,ams)]/SHLP`+ACCOUNT


@@ ****** ALTS SECTION *******

&CMD`+ALTS`PENNMUSH [u(cobj,ams)]=$^(?\:\+)?alts(?\:/(\S+)?)?(?\: +(.+?))?(?\:=(.*))?$:@attach %!/CMD`+ALTS`MAIN
@set [u(cobj,ams)]/CMD`+ALTS`PENNMUSH=regexp
&CMD`+ALTS`RHOSTMUSH [u(cobj,ams)]=$^(?\:\+)?alts(?\:/(\\S+)?)?(?\: +(.+?))?(?\:=(.*))?$:@attach %!/CMD`+ALTS`MAIN
@set [u(cobj,ams)]/CMD`+ALTS`RHOSTMUSH=regexp
&CMD`+ALTS`MAIN [u(cobj,ams)]=th u(setq,sysname,ALTS);@attach %!/INC`GETSWITCH=%1;@attach %!/INC`ALTS`[u(strfirstof,%q<switch>,MAIN)]=%2,%3
@set [u(cobj,ams)]/CMD`+ALTS`[u(choosegame,RHOSTMUSH,PENNMUSH)]=no_command

&SWITCHES`ALTS`PLAYER [u(cobj,ams)]=LIST|PRIORITY
&SWITCHES`ALTS`ADMIN [u(cobj,ams)]=

&INC`ALTS`MAIN [u(cobj,ams)]=@attach %!/INC`CHECKPC=u(strfirstof,%0,%#),1;@check get(%q<t1>/D`ALTS)=@attach %!/INC`MSG=[name(%q<t1>)] is not on any alts lists.;@attach %!/INC`MSG=Alts of [ansi(h,%q<t1name>)] ([u(hideidle,%q<t1>)]): [u(FUN`ALTS`LIST,%q<t1>)]

&INC`ALTS`LIST [u(cobj,ams)]=@check u(setr,accid,u(accid,%#,1))=@attach %!/INC`MSG=ERROR: This character is not bound to an account.;@check strlen(%0)=@attach %!/INC`MSG=ERROR: List or target field empty. Please enter a name or a number to list this alt under.;@select/inline cand(strlen(%0),strlen(%1))=1,{@attach %!/INC`CHECKPC=%0,1;@check strmatch(u(accid,%q<t1objid>),%q<accid>)=@attach %!/INC`MSG=ERROR: %q<t1name> is not one of your registered characters.;@check cand(gte(u(setr,list,%1),0),isint(%1))=@attach %!/INC`MSG=ERROR: Alts list must be a whole number 0 or greater.},0,{@attach %!/INC`CHECKPC=%#,1;@check t(match(lnum(0,255),u(setr,list,%0)))=@attach %!/INC`MSG=ERROR: Alts list must be a whole number 0-255.};&D`ALTS %q<t1>=%q<list>;@attach %!/INC`DOSQL=SET`ALTS,%q<list>,%q<t1id>;@attach %!/INC`MSG=Okay! %q<t1name> will [if(%q<list>,now appear in Alts List #%q<list>.,not appear in any Alts lists.)]

&FUN`ALTS`LIST [u(cobj,ams)]=if(get(%0/D`ALTS),u(strfirstof,u(itemize,iter(u(sortname,squish(iter(get(u(accid,%0)/CHARACTERS),if(eq(default(%0/D`ALTS,0),default(%i0/D`ALTS,0)),%i0)))),u(moniker,%i0)[if(not(%1),\([u(hideidle,%i0)]\))],%b,|),|,and,\,),None),None)

&Q`SET`ALTS [u(Cobj,ams)]=UPDATE vol_character SET character_alt=? WHERE character_id=?

&INC`ALTS`PRIORITY [u(cobj,ams)]=@check u(setr,accid,u(accid,%#,1))=@attach %!/INC`MSG=ERROR: This character is not bound to an account.;@select/inline t(strlen(%0))=1,{@select/inline cand(strlen(%0),strlen(%1))=1,{@attach %!/INC`CHECKPC=%0,1;@check strmatch(u(accid,%q<t1objid>),%q<accid>)=@attach %!/INC`MSG=ERROR: %q<t1name> is not one of your registered characters.;@check cand(gte(u(setr,list,%1),0),isint(%1))=@attach %!/INC`MSG=ERROR: Alts priority must be a whole number 0 or greater.},0,{@attach %!/INC`CHECKPC=%#,1;@check cand(gte(u(setr,list,%0),0),isint(%0))=@attach %!/INC`MSG=ERROR: Alts priority must be a whole number 0 or greater.};&D`ALTS`PRIORITY %q<t1>=%q<list>;@attach %!/INC`MSG=Okay! %q<t1name>'s Priority is now: %q<list>},0,{@attach %!/INC`ALTS`PRIORITY`LIST}

&INC`ALTS`PRIORITY`LIST [u(cobj,ams)]=@attach %!/INC`MSG=Your Alts by Priority: [iter(revwords(u(sortpriority,u(alts,%#))),u(moniker,%i0) ([default(%i0/D`ALTS`PRIORITY,0)]),%b,\,%b)]

&HLP`+ALTS [u(cobj,ams)]=The Alts system allows you to specify what characters of yours other players can associate with you. It also allows you to configure which alts take precedent (if any) for receiving messages from channels and BBS notifications.%R%R[ansi(hc,Commands)]%R[align(5 [sub(u(width,%#),6)],,[ansi(h,+alts <target>)] - Check someone's alts. Alts are any characters with the same ALT ID. Without a target it will use yourself\, showing you what others would see.%R[ansi(h,+alts/list <#>)] or [ansi(h,+alts/list <alt>=<#>)] - Set your current character or an alt of yours to use a specific ALT ID. Characters with the same ALT ID are linked on +alts displays. Alt IDs are numbers.%R%RAll Alts begin with Alt ID 0\, which is special. Characters with Alt ID 0 have no alts period.%R%R[ansi(h,+alts/priority <#>)] or [ansi(h,+alts/priority <alt>=<#>)] - Set your Alt PRIORITY.%R[ansi(h,+alts/priority)] - Show the priority settings of all your alts.%R%RThe PRIORITY affects channel reception. In both cases\, the HIGHEST PRIORITY ALT who is eligible to receive the message \(has the channel turned on and not gagged\) will receive it. Where multiple alts have the same priority\, all with that priority will receive it.%R%RFor example\, if Alts A and B are set to Priority 1 and have the Public channel on\, and Alt C also has it on but is priority 0\, only A and B will see messages from the Public channel. If A and B gag or turn it off\, C will once again receive Public messages.)]
+help/add Character/+alts=[u(cobj,ams)]/HLP`+ALTS

@@ ******* IP SECTION *********

&CMD`+IP`PENNMUSH [u(cobj,ams)]=$^(?\:\+)?(?\:ip|sitematch|matchsite|site)(?\:/(\S+)?)?(?\: +(.+?))?(?\:=(.*))?$:@attach %!/CMD`+IP`MAIN
@set [u(cobj,ams)]/CMD`+IP`PENNMUSH=regexp
&CMD`+IP`RHOSTMUSH [u(cobj,ams)]=$^(?\:\+)?(?\:ip|sitematch|matchsite|site)(?\:/(\\S+)?)?(?\: +(.+?))?(?\:=(.*))?$:@attach %!/CMD`+IP`MAIN
@set [u(cobj,ams)]/CMD`+IP`RHOSTMUSH=regexp
&CMD`+IP`MAIN [u(cobj,ams)]=th u(setq,sysname,IP);@attach %!/INC`GETSWITCH=%1;@attach %!/INC`IP`[u(strfirstof,%q<switch>,MAIN)]=%2,%3
@set [u(cobj,ams)]/CMD`+IP`[switch(%va,PennMUSH,RHOSTMUSH,RhostMUSH,PENNMUSH)]=no_command

&SWITCHES`IP`PLAYER [u(cobj,ams)]=
&SWITCHES`IP`ADMIN [u(cobj,ams)]=IP|GUESTS|CLEAR

&INC`IP`MAIN [u(cobj,ams)]=@stop u(isguest,%#)=@attach %!/INC`MSG=ERROR: Guests cannot use +ip.;@select/inline u(isadmin,%#)=0,{@attach %!/INC`CHECKPC=%#,1,1;@attach %!/INC`IP`IPSHOW=%q<t1>,0},{@attach %!/INC`CHECKPC=u(strfirstof,%0,%#),1,1;@@ @stop u(isguest,%q<t1>)=@attach %!/INC`MSG=ERROR: To match Guests\, please use +ip/guests;@attach %!/INC`IP`IPSHOW=%q<t1>}

&INC`IP`IP [u(cobj,ams)]=@check strlen(%0)=@attach %!/INC`MSG=ERROR: An IP address is required.;@attach %!/INC`IP`IPSHOW=%0,1,1

&INC`IP`CLEAR [u(cobj,ams)]=@attach %!/INC`CHECKPC=%0,1;@attach %!/INC`DOSQL=DELETE`ALL_LOGS,%q<t1objid>;@attach %!/INC`MSG=Cleared all login records for %q<t1name>!;@attach %!/INC`MSG`CHAN=Cleared all login records for %q<t1name>!

&INC`IP`IPSHOW [u(cobj,ams)]=@check gt(words(u(setr,ips,if(%2,%0,u(mysql,GET`LOGIN_IPS,%q<t1id>)))),0)=@attach %!/INC`MSG=ERROR: No IP logs found to match against.;th u(setq,pcs,u(filter,if(u(isadmin,%#),ISOBJID,OBJNOTGUEST),u(mysql,GET`OBJIDS_FROM_IPS,u(SQL`IN`STRING,%q<ips>))));@check words(%q<pcs>)=@attach %!/INC`MSG=ERROR: No Matching Logs found.;@pemit %#=u(header,Site matches for [if(%2,%0,name(%0))]);@dolist/inline %q<pcs>={@pemit %#=u(separator,ansi(h,u(pueblize,u(moniker,##),+finger [name(##)]))[ansi(h,\(##\))] - [u(lastidle,##)]);@pemit %#=ansi(u(color,%#,%q<sysname>,COLUMN_NAMES),align(20 22 25,Date,Address,Result));@pemit %#=iter(u(mysql2,GET`LOGINS,objid(##)),align(20 22 25,u(fancytime,elements(%i0,3,^),%#),elements(%i0,2,^),if(elements(%i0,1,^),Success,elements(%i0,4,^))),|,%R)};@pemit %#=u(footer)

&Q`GET`LOGIN_IPS [u(cobj,ams)]=SELECT DISTINCT ip_address FROM volv_login WHERE character_id=? AND login_is_success=1

&FIL`OBJNOTGUEST [u(cobj,ams)]=cand(isobjid(%0),not(u(isguest,%0)))

&Q`GET`OBJIDS_FROM_IPS [u(cobj,ams)]=SELECT DISTINCT character_objid from volv_login WHERE ip_address IN (!) ORDER BY player_name DESC

&Q`GET`LOGINS [u(cobj,ams)]=SELECT login_is_success,ip_address,login_date FROM volv_login WHERE character_objid=? LIMIT 10

&PLAYER`CONNECT`IPLOG [u(cobj,ams)]=@attach %!/INC`CHECKPC=%0,1;th u(call`3,volp_login_record,0,%q<t1id>,1,'[sqlescape(get(%0/LASTIP))]')

&PLAYER`CONNECTFAIL`IPLOG [u(cobj,ams)]=@attach %!/INC`CHECKPC=%0,1;th u(call`3,volp_login_record,0,%q<t1id>,0,'[sqlescape(get(%0/LASTIP))]')

&SOCKET`LOGINFAIL`IPLOG [u(cobj,ams)]=@select/inline isdbref(%4)=1,{@trigger %!/PLAYER`CONNECTFAIL`IPLOG=%4,%3;th u(setq,isgod,strmatch(#1,%4))[u(setq,admin,u(isadmin,%4))];@attach %!/INC`MSG`SYSCHAN={[if(cor(%q<isgod>,%q<admin>),ansi(hr,WARNING:),ansi(hy,ALERT:))]%BFailed [switch(1,%q<isgod>,ansi(hr,GOD),%q<admin>,ansi(hr,ADMIN),Player)] ([name(%4)]) login attempt from IP '%1' HOST '[host(%0)]' PORT '%0'. Consecutive Failure %2: %3. [if(strmatch(get(%4/LASTSITE),host(%0)),,ansi(hr,ALERT:)%BAttempt not from previous LASTSITE!)]};@select/inline cor(%q<isgod>,%q<admin>)=1,{@pemit/port %0=[ansi(hrf,WARNING:)]%BAdmin login failures are logged.};@select/inline %2=>1,{@pemit/port %0=If you have forgotten your password\, ask an admin for a reset. Too many login attempts will cause a temporary lockout.}}

&HLP`IP [u(cobj,ams)]=[ansi(h,+ip)] - Shows your recent logins. Please report any suspicious login attempts to staff!
+help/add Character/+ip=[u(cobj,ams)]/HLP`IP

&SHLP`IP [u(cobj,ams)]=[ansi(h,+ip <player>)] - Checks a player's logins and anyone with matching IPs.%R[ansi(h,+ip/guests <player>)] - Includes Guests in the IP lookup.%R[ansi(h,+ip/ip <ip>)] - Checks an IP for any matching players. Note that ::ffff: must be prepended to any IPv4 addresses if they're showing up in normal uses of +ip!
+shelp/add Character/+ip=[u(cobj,ams)]/SHLP`IP

@@ ****** APPROVAL SECTION *********
&CMD`+APPROVE`PENNMUSH [u(cobj,ams)]=$^(?\:\+)?(approve|unapprove)(?\:/(\S+)?)?(?\: +(.+?))?(?\:=(.*))?$:@attach %!/CMD`+APPROVE`MAIN
@set [u(cobj,ams)]/CMD`+APPROVE`PENNMUSH=regexp
&CMD`+APPROVE`RHOSTMUSH [u(cobj,ams)]=$^(?\:\+)?(approve|unapprove)(?\:/(\\S+)?)?(?\: +(.+?))?(?\:=(.*))?$:@attach %!/CMD`+APPROVE`MAIN
@set [u(cobj,ams)]/CMD`+APPROVE`RHOSTMUSH=regexp
&CMD`+APPROVE`MAIN [u(cobj,ams)]=th u(setq,sysname,APPROVE);@attach %!/INC`GETSWITCH=%2;@attach %!/INC`%1`[u(strfirstof,%q<switch>,MAIN)]=%3,%4
@set [u(cobj,ams)]/CMD`+APPROVE`[u(choosegame,RHOSTMUSH,PENNMUSH)]=no_command

&SWITCHES`APPROVE`PLAYER [u(cobj,ams)]=LIST
&SWITCHES`APPROVE`ADMIN [u(cobj,ams)]=

&INC`APPROVE`MAIN [u(cobj,ams)]=@select/inline cand(u(isadmin,%#),strlen(%0))=1,{@attach %!/INC`CHECKPC=%0,1;@stop u(isapproved,%q<t1>)=@attach %!/INC`MSG=ERROR: They are already approved!;@attach %!/INC`APPROVE`DO=%q<t1>,%#,%1;@attach %!/INC`MSG=You have approved %q<t1name> for play!;@attach %!/INC`MSG`CHAN=%q<t1name> approved for play!},{@attach %!/INC`MSG=You [if(u(isapproved,%#),ansi(hg,are),ansi(hr,are not))] are approved for play!}

&INC`APPROVE`DO [u(cobj,ams)]=@check u(setr,results,u(call`4,volp_approve,0,get(%0/D`ID),get(%1/D`ID),1,'[sqlescape(%2)]'))=@attach %!/INC`MSG=ERROR: Could not run approval. reason: %q<results>;th u(attrib_set,%0,D`APPROVED,secs());th u(attrib_set,%0,V`APPROVED,secs());@select/inline words(u(setr,channels,u(conf,APPROVE_CHANNELS)))=>0,{@attach %!/INC`MSG`CHAN=[ansi(h,u(moniker,%0))] is now approved for play![if(strlen(%2),%b%2)],u(conf,APPROVE_CHANNELS),,1,,1}

&Q`SET`APPROVE [u(cobj,ams)]=UPDATE vol_character SET character_date_approved=UTC_TIMESTAMP(),character_is_approved=1
&Q`SET`UNAPPROVE [u(cobj,ams)]=UPDATE vol_character SET character_date_approved=NULL,character_is_approved=0

&INC`UNAPPROVE`DO [u(cobj,ams)]=@check u(setr,results,u(call`4,volp_approve,0,get(%0/D`ID),get(%1/D`ID),0,'[sqlescape(%2)]'))=@attach %!/INC`MSG=ERROR: Could not run un-approval. reason: %q<results>;th u(attrib_set,%0,D`APPROVED,0);th u(attrib_set,%0,V`APPROVED,0);@select/inline words(u(setr,channels,u(conf,UNAPPROVE_CHANNELS)),|)=>0,{@attach %!/INC`MSG`CHAN=[ansi(h,u(moniker,%0))] is no longer approved for play![if(strlen(%2),%b%2)],%q<channels>,,1,,1}

&INC`UNAPPROVE`MAIN [u(cobj,ams)]=@select/inline u(isadmin,%#)=1,{@attach %!/INC`CHECKPC=%0,1;@check u(isapproved,%q<t1>)=@attach %!/INC`MSG=ERROR: They are not approved!;@attach %!/INC`UNAPPROVE`DO=%q<t1>,%#,%1;@attach %!/INC`MSG=You have unapproved %q<t1name> for play!;@attach %!/INC`MSG`CHAN=%q<t1name> unapproved for play.;@attach %!/INC`MSG`PUBCHAN=%q<t1name> unapproved for play.},{@attach %!/INC`MSG=You [if(u(isapproved,%#),ansi(hg,are),ansi(hr,are not))] are approved for play!}

&CONFIG`APPROVE_CHANNELS [u(cobj,ams)]=Channels to announce Approvals (and optional blurb message) on.
&CONFIG`APPROVE_CHANNELS`DEFAULT [u(Cobj,ams)]=
&CONFIG`APPROVE_CHANNELS`VALID [u(Cobj,ams)]=LIST

&CONFIG`UNAPPROVE_CHANNELS [u(cobj,ams)]=Channels to announce un-Approvals (and optional blurb message) on.
&CONFIG`UNAPPROVE_CHANNELS`DEFAULT [u(Cobj,ams)]=
&CONFIG`UNAPPROVE_CHANNELS`VALID [u(Cobj,ams)]=LIST

&SHLP`+APPROVE [u(cobj,ams)]=[ansi(h,+approve <name>)]%RThis will approve <name>%R%R[ansi(h,+unapprove <name>)]%RThis will unapprove <name>%R%RStaff are always considered 'approved' but may need to have the UNREGISTERED flag removed with @set if they intend to use @powers.
+shelp/add Character/+approve=[u(cobj,ams)]/SHLP`+APPROVE

@@ ******** ID SECTION *******
&CMD`+ID`PENNMUSH [u(cobj,ams)]=$^(?\:\+)?(id)(?\:/(\S+)?)?(?\: +(.+?))?(?\:=(.*))?$:@attach %!/CMD`+ID`MAIN
@set [u(cobj,ams)]/CMD`+ID`PENNMUSH=regexp
&CMD`+ID`RHOSTMUSH [u(cobj,ams)]=$^(?\:\+)?(id)(?\:/(\\S+)?)?(?\: +(.+?))?(?\:=(.*))?$:@attach %!/CMD`+ID`MAIN
@set [u(cobj,ams)]/CMD`+ID`RHOSTMUSH=regexp
&CMD`+ID`MAIN [u(cobj,ams)]=th u(setq,sysname,ID);@attach %!/INC`GETSWITCH=%2;@attach %!/INC`ID`[u(strfirstof,%q<switch>,MAIN)]=%3,%4
@set [u(cobj,ams)]/CMD`+ID`[u(choosegame,RHOSTMUSH,PENNMUSH)]=no_command

&SWITCHES`ID`ADMIN [u(cobj,ams)]=SEARCH|MERGE

&INC`ID`MAIN [u(cobj,ams)]=@attach %!/INC`CHECKPC=u(strfirstof,%0,%#),1;@attach %!/INC`MSG=The Database ID for %q<t1name> is: %q<t1id>

&INC`ID`SEARCH [u(Cobj,ams)]=@pemit %#=u(header,Database IDs for Characters Like: %0);@pemit %#=ansi(u(color,%#,COLUMN_NAMES),align(1 6 30 36,D,ID,OBJID,Name));@pemit %#=u(separator);@dolist/inline/delimit [chr(176)] [u(mysql3,SEARCH`CHARACTERS,sqlescape(%0))]={th u(setq,data,u(choosegame,%i0,%d0));@pemit %#=align(1 6 30 36,if(elements(%q<data>,1,chr(177)),ansi(hr,X),%b),elements(%q<data>,2,chr(177)),elements(%q<data>,3,chr(177)),elements(%q<data>,4,chr(177)))};@pemit %#=u(footer)

&Q`SEARCH`CHARACTERS [u(cobj,ams)]=SELECT character_is_deleted,character_id,character_objid,character_name FROM volv_character WHERE character_name LIKE '%!%' ORDER BY character_name

&INC`ID`MERGE [u(cobj,ams)]=@attach %!/INC`CHECKPC=%0,1;@check u(setr,oldid,u(mysql,EXACT`CHARACTER_ID,%1))=@attach %!/INC`MSG=ERROR: Could not find ID '%1';@attach %!/INC`VERIFY=[ansi(hr,WARNING:)] This will merge %q<t1name> into the Old Character ID '%1'. All scenes\, jobs\, and board posts of Character ID %q<t1id> will be assigned to the old ID. Other data associated with ID %q<t1id> will be lost. Is this okay? Enter the same command again in ten seconds to continue.,MERGE %q<t1> %q<oldid>;@dolist/inline JLINK BB BB2 PLOT ACTOR={@attach %!/INC`DOSQL=MERGE`##,%q<oldid>,%q<t1id>};@attach %!/INC`DOSQL=MERGE`DELETE_OLD,%q<t1id>;@attach %!/INC`DOSQL=MERGE`RESURRECT,%q<oldid>;@attach %!/INC`DOSQL=MERGE`OBJID,%q<t1objid>,%q<oldid>;th u(attrib_set,%q<t1>,D`ID,%q<oldid>);@attach %!/INC`MSG`CHAN=Re-Assigned %q<t1name> to the Old ID: %q<oldid>;@attach %!/INC`MSG`NOTICE=You were re-assigned the old character id: %q<oldid>,%q<t1>;@attach %!/INC`MSG=Reassignment complete.

&Q`EXACT`CHARACTER_ID [u(cobj,ams)]=SELECT character_id FROM volv_character WHERE character_id=? LIMIT 1

&Q`MERGE`DELETE_OLD [u(cobj,ams)]=DELETE from vol_entity WHERE entity_id=?
&Q`MERGE`OBJID [u(Cobj,ams)]=UPDATE vol_entity SET entity_objid=? WHERE entity_id=?
&Q`MERGE`RESURRECT [u(cobj,ams)]=UPDATE vol_character SET character_is_deleted=0 WHERe character_id=?

&Q`MERGE`JLINK [u(cobj,ams)]=UPDATE vol_jlink SET character_id=? WHERE character_id=?
&Q`MERGE`BB [u(cobj,ams)]=UPDATE vol_bbpost SET entity_id=? WHERE entity_id=?
&Q`MERGE`BB2 [u(cobj,ams)]=UPDATE vol_bbcomment SET entity_id=? WHERE entity_id=?
&Q`MERGE`PLOT [u(cobj,ams)]=UPDATE vol_runner SET character_id=? WHERE entity_id=?
&Q`MERGE`ACTOR [u(cobj,ams)]=UPDATE vol_actor SET character_id=? WHERE entity_id=?

&PLAYER`CREATE`MATCH [u(cobj,ams)]=@check words(u(setr,results,u(mysql3,SEARCH`CHARACTERS_NEW,sqlescape(%1))),chr(176))={@attach %!/INC`MSG`CHAN=[ansi(hr,ALERT:)] Character '%1' (%0) Created! If this is a re-created old character\, check +shelp +id about re-assigning their old ID.;@select/inline isdbref(%#)=1,{@attach %!/INC`MSG=[ansi(hr,ALERT:)] Character '%1' (%0) Created! If this is a re-created old character\, check +shelp +id about re-assigning their old ID.,%#}};@attach %!/INC`MSG`CHAN=[ansi(hr,ALERT:)] Character '%1' (%0) Created! Possible re-creation of: [iter(%q<results>,elements(%i0,3,chr(177)) - \([elements(%i0,1,chr(177))]\, [elements(%i0,2,chr(177))]\),chr(176),\,%b)]. Check +shelp +id for info about re-assigning old ids.;@select/inline isdbref(%#)=1,{@attach %!/INC`MSG=[ansi(hr,ALERT:)] Character '%1' (%0) Created! Possible re-creation of: [iter(%q<results>,elements(%i0,3,chr(177)) - \([elements(%i0,1,chr(177))]\, [elements(%i0,2,chr(177))]\),chr(176),\,%b)]. Check +shelp +id for info about re-assigning old ids.,%#}

&Q`SEARCH`CHARACTERS_NEW [u(cobj,ams)]=SELECT character_id,character_objid,character_name FROM volv_character WHERE character_name LIKE '%!%' AND character_is_deleted=1


@@ ********* STAFF SECTION ********
&CMD`+STAFF`PENNMUSH [u(cobj,ams)]=$^(?\:\+)?(staff|admin|wizlist)(?\:/(\S+)?)?(?\: +(.+?))?(?\:=(.*))?$:@attach %!/CMD`+STAFF`MAIN
@set [u(cobj,ams)]/CMD`+STAFF`PENNMUSH=regexp
&CMD`+STAFF`RHOSTMUSH [u(cobj,ams)]=$^(?\:\+)?(staff|admin|wizlist)(?\:/(\\S+)?)?(?\: +(.+?))?(?\:=(.*))?$:@attach %!/CMD`+STAFF`MAIN
@set [u(cobj,ams)]/CMD`+STAFF`RHOSTMUSH=regexp
&CMD`+STAFF`MAIN [u(cobj,ams)]=th u(setq,sysname,STAFF);@attach %!/INC`GETSWITCH=%2;@attach %!/INC`STAFF`[u(strfirstof,%q<switch>,MAIN)]=%3,%4
@set [u(cobj,ams)]/CMD`+STAFF`[u(choosegame,RHOSTMUSH,PENNMUSH)]=no_command

&SWITCHES`STAFF`ADMIN [u(cobj,ams)]=DUTY

&INC`STAFF`MAIN [u(cobj,ams)]=@check isdbref(u(setr,staff,u(conf,STAFF_GROUP)))=@attach %!/INC`MSG=ERROR: Staff Group not found! Tell a Wizard to +gameconfig one up!;@pemit %#=u(header,mudname() Staff);@pemit %#=ansi(u(color,%#,COLUMN_NAMES),align(3 20 3 40 8,Idl,Name,Bit,Position,Duty));@pemit %#=u(separator);@dolist/inline u(filter,ISOBJID,get(%q<staff>/COMMAND))=@pemit %#=u(FUN`WIZLIST,##,%#,num(%q<staff>));@select/inline t(strlen(u(setr,smsg,u(conf,WIZLIST_FOOTER))))=1,{@pemit %#=u(separator);@pemit %#=%q<smsg>};@pemit %#=u(footer)

&FUN`WIZLIST [u(cobj,ams)]=localize(align(3 20 3 40 8,u(hideidle,%0),u(moniker,%0),u(choosegame,switch(1,u(iswizard,%0),ansi(hr,WIZ),hasflag(%0,ROYALTY),ansi(hc,ROY),ansi(hx,N/A)),bittype(%0)),default(%0/D`GROUP`%2`TITLE,???),u(setq,adm,u(isadmin,%#))[u(setq,hid,u(ishidden,%0))][u(setq,conn,objeval(%#,gt(conn(%0),0)))][u(setq,vac,t(get(%0/D`STAFF`VACATION)))][u(setq,admsee,cand(%q<conn>,%q<hid>,%q<adm>))][u(setq,dut,t(get(%0/D`STAFF`DUTY)))][if(%q<vac>,ansi(if(%q<conn>,hg,hx),Vac),if(%q<dut>,if(%q<conn>,if(%q<admsee>,ansi(hx,On),ansi(hg,On)),ansi(hx,Off)),ansi(hx,Off)))]))

&INC`STAFF`DUTY [u(cobj,ams)]=@select/inline u(setr`%va,duty,not(default(%#/D`STAFF`DUTY,0)))=1,{@attach %!/INC`MSG=You are now On duty!},0,{@attach %!/INC`MSG=You are now Off Duty!};&D`STAFF`DUTY %#=%q<duty>

&HLP`+STAFF [u(cobj,ams)]=+staff lists the game's administrators and their current status.%R[ansi(hc,See Also:)] [u(pueblize,help JUDGE)], [u(pueblize,help ROYALTY)], [u(pueblize,help WIZARD)]%R%R[align(5 [sub(u(width,%#),6)],,[ansi(h,+staff)] - Show game's staff members.)]
+help/add Community/+staff=[u(cobj,ams)]/HLP`+STAFF

&SHLP`+STAFF [u(cobj,ams)]=Keep in mind that anyone on this list is able to use all softcoded admin commands!%R%R[ansi(hc,Staff Commands)]%R[align(5 [sub(u(width,%#),6)],,[ansi(h,+staff)] - Lists staff. Identical to wizlist.%R%RHow do you add Staff?%RThe Staff List is pulled from the Group System. See [u(pueblize,+shelp +gameconfig)])]%R%R[ansi(hc,Staff List Display)]%R[align(5 [sub(u(width,%#),6)],,[ansi(h,+staff/duty)] - Toggle duty status on or off.%R[ansi(h,+staff/vacation)] - Go 'on vacation' or toggle it off.)]
+shelp/add Administration/+staff=[u(cobj,ams)]/SHLP`+STAFF

@@ *********** WATCH SECTION *******
&CMD`+WATCH`PENNMUSH [u(cobj,ams)]=$^(?s)(?\:\+)?(?\:watch|wf|friend|friends)(?\:/(\S+)?)?(?\: +(.*))?$:@attach %!/CMD`+WATCH`MAIN
@set [u(cobj,ams)]/CMD`+WATCH`PENNMUSH=regexp
&CMD`+WATCH`RHOSTMUSH [u(cobj,ams)]=$^(?s)(?\:\+)?(?\:watch|wf|friend|friends)(?\:/(\\S+)?)?(?\: +(.*))?$:@attach %!/CMD`+WATCH`MAIN
@set [u(cobj,ams)]/CMD`+WATCH`RHOSTMUSH=regexp
&CMD`+WATCH`MAIN [u(cobj,ams)]=@stop u(isguest,%#)=@attach %!/INC`MSG=ERROR: Guests may not use +watch.;th u(setq,sysname,WATCH);@attach %!/INC`GETSWITCH=%1;@attach %!/INC`WATCH`[u(strfirstof,%q<switch>,MAIN)]=%2,%3
@set [u(cobj,ams)]/CMD`+WATCH`[u(choosegame,RHOSTMUSH,PENNMUSH)]=no_command

&SWITCHES`WATCH`PLAYER [u(cobj,ams)]=ADD|LIST|DELETE|HIDE|MUTE|ACCADD|ACCDELETE

&INC`WATCH`MAIN [u(cobj,ams)]=th u(setq,lwhoid,u(lwhoid,%#));@pemit %#=u(header,Watch - Online);@attach %!/INC`WHO`HEADER`MAIN;@pemit %#=u(separator,Account Watch);@dolist/inline/nobreak u(sortidle,u(filter,ISOBJID,setinter(u(mysql,SELECT`WATCH,get(%#/D`ACCOUNT`ID)),%q<lwhoid>)))={@check gte(objeval(%#,conn(##)),0);@pemit %#=u(FUN`WHO`PLAYERLINE`MAIN,##)};@pemit %#=u(separator,Character Watch);@dolist/inline/nobreak u(sortidle,u(filter,ISOBJID,setinter(u(mysql,SELECT`WATCH,get(%#/D`ID)),%q<lwhoid>)))={@check gte(objeval(%#,conn(##)),0);@pemit %#=u(FUN`WHO`PLAYERLINE`MAIN,##)};@pemit %#=u(footer)

&INC`WATCH`LIST [u(cobj,ams)]=th u(setq,lwhoid,u(lwhoid,%#));@pemit %#=u(header,Watch - All);@attach %!/INC`WHO`HEADER`MAIN;@pemit %#=u(separator,Account Watch);@dolist/inline/nobreak u(filter,ISOBJID,u(mysql,SELECT`WATCH,get(%#/D`ACCOUNT`ID)))={@pemit %#=u(FUN`WHO`PLAYERLINE`MAIN,##)};@pemit %#=u(separator,Character Watch);@dolist/inline/nobreak u(filter,ISOBJID,u(mysql,SELECT`WATCH,get(%#/D`ID)))={@pemit %#=u(FUN`WHO`PLAYERLINE`MAIN,##)};@pemit %#=u(footer)

&INC`WATCH`ADD [u(cobj,ams)]=@check strlen(%0)=@attach %!/INC`MSG=ERROR: No player entered to add.;@attach %!/INC`CHECKPC=%0,1;@stop match(u(mysql,SELECT`WATCH,get(%#/D`ID)),%q<t1objid>)=@attach %!/INC`MSG=ERROR: They are already a friend.;@attach %!/INC`DOSQL=INSERT`WATCH,get(%#/D`ID),%q<t1id>;@attach %!/INC`MSG=%q<t1name> added to your Friends list!

&Q`INSERT`WATCH [u(cobj,ams)]=INSERT IGNORE INTO vol_watch (entity_id,character_id) VALUES (?,?)

&Q`SELECT`WATCH [u(cobj,ams)]=SELECT character_objid FROM volv_watch WHERE watcher_id=? ORDER BY character_name

&INC`WATCH`DELETE [u(cobj,ams)]=@check strlen(%0)=@attach %!/INC`MSG=ERROR: No player entered to remove.;@attach %!/INC`CHECKPC=%0,1;@check match(u(mysql,SELECT`WATCH,get(%#/D`ID)),%q<t1objid>)=@attach %!/INC`MSG=ERROR: They are not a friend.;@attach %!/INC`DOSQL=DELETE`WATCH,get(%#/D`ID),%q<t1id>;@attach %!/INC`MSG=%q<t1name> removed from your Friends list!

&Q`DELETE`WATCH [u(cobj,ams)]=DELETE FROM vol_watch WHERE entity_id=? AND character_id=?

&INC`WATCH`ACCADD [u(cobj,ams)]=@check strlen(%0)=@attach %!/INC`MSG=ERROR: No player entered to add.;@attach %!/INC`CHECKPC=%0,1;@stop match(u(mysql,SELECT`WATCH,get(%#/D`ACCOUNT`ID)),%q<t1objid>)=@attach %!/INC`MSG=ERROR: They are already an Account Friend.;@attach %!/INC`DOSQL=INSERT`WATCH,get(%#/D`ACCOUNT`ID),%q<t1id>;@attach %!/INC`MSG=%q<t1name> added to your Account Friends list!

&INC`WATCH`ACCDELETE [u(cobj,ams)]=@check strlen(%0)=@attach %!/INC`MSG=ERROR: No player entered to remove.;@attach %!/INC`CHECKPC=%0,1;@check match(u(mysql,SELECT`WATCH,get(%#/D`ACCOUNT`ID)),%q<t1objid>)=@attach %!/INC`MSG=ERROR: They are not an Account friend.;@attach %!/INC`DOSQL=DELETE`WATCH,get(%#/D`ACCOUNT`ID),%q<t1id>;@attach %!/INC`MSG=%q<t1name> removed from your Account Friends list!

&INC`WATCH`HIDE [u(cobj,ams)]=th setq(choose,if(t(get(%#/D`WATCH`HIDE)),0,1));@attach %!/INC`MSG=Your connects and disconnects will [if(%q<choose>,now,no longer)] alert anyone who has you on their friends list.;&D`WATCH`HIDE %#=%q<choose>

&INC`WATCH`MUTE [u(cobj,ams)]=th setq(choose,if(t(get(%#/D`WATCH`MUTE)),1,0));@attach %!/INC`MSG=You will [if(%q<choose>,now,no longer)] be alerted when your friends connect or disconnect.;&D`WATCH`MUTE %#=%q<choose>

&PLAYER`CONNECT`WATCH [u(cobj,ams)]=@stop cor(u(ishidden,%0),get(%0/D`WATCH`HIDE),gt(%1,1));th u(setq,lwhoid,u(lwhoid));@check words(u(setr,watchers,u(mysql,SELECT`WATCHERS,get(%0/D`ID))));@check words(u(setr,final,u(filter,NOTMUTE,setinter(iter(%q<watchers>,switch(type(%i0),PLAYER,%i0,THING,get(%i0/MEMBERS))),%q<lwhoid>))));@attach %!/INC`MSG=[u(moniker,%0)] has connected.,%q<final>,WATCH

&Q`SELECT`WATCHERS [u(cobj,ams)]=SELECT watcher_objid FROM volv_watch WHERE character_id=?

&PLAYER`DISCONNECT`WATCH [u(cobj,ams)]=@select/inline %1=0,{&IDLERS [u(cobj,ams)]=setdiff(v(IDLERS),%0)};@stop cor(u(ishidden,%0),get(%0/D`WATCH`HIDE),gt(%1,1));th u(setq,lwhoid,u(lwhoid));@check words(u(setr,watchers,u(mysql,SELECT`WATCHERS,get(%0/D`ID))));@check words(u(setr,final,u(filter,NOTMUTE,setinter(iter(%q<watchers>,switch(type(%i0),PLAYER,%i0,THING,get(%i0/MEMBERS))),%q<lwhoid>))));@attach %!/INC`MSG=[u(moniker,%0)] has disconnected.,%q<final>,WATCH

&FIL`NOTMUTE [u(cobj,ams)]=not(get(%0/D`WATCH`MUTE))

&STARTUP`WATCH [u(cobj,ams)]=@trigger %!/TRG`INDEXIDLE

&TRG`INDEXIDLE [u(cobj,ams)]=th setq(idlers,u(filter,IDLING,u(setr,who,setunion(u(lwhoid),))));@dolist setdiff(v(IDLERS),%q<idlers>)={@check words(u(setr,adwatch,u(filter,ISADMIN,u(filter,NOTMUTE,u(filter,MATCHWATCH,%q<who>,%b,%b,##)))));@attach %!/INC`MSG=[name(%i0)] is no longer idle.,%q<adwatch>;@switch/inline cand(gt(u(getstat,%!/IDLERS`TIMES,##),u(stringsecs,config(idle_timeout))),u(ishidden,##))=1,{@switch/inline hasflag(%i0,DARK)=1,{@attach %!/INC`MSG=You are both Hidden and Dark.,##},0,{@attach %!/INC`MSG=Coming out of @hide from unidling.,##;@hide/off ##}}};&IDLERS [u(cobj,ams)]=%q<idlers>;&IDLERS`TIMES [u(cobj,ams)]=iter(%q<idlers>,%i0~[idle(%i0)],%b,|);@wait 60=@trigger %!/TRG`INDEXIDLE

&FIL`IDLING [u(cobj,ams)]=gt(idle(%0),mul(60,60))

@@ COMMUNITY - WATCH
&HLP`+WATCH [u(cobj,ams)]=The Watch system alerts you as friends connect and disconnect.[if(isdbref(u(cobj,accounts)),%BThe List is shared across all alts.)]%R[ansi(hc,Aliases:)] +friend, friend, watch, wf, +wf%R%R[ansi(hc,Commands)]%R[align(5 [sub(u(width,%#),6)],,[ansi(h,+watch)] - Will display online friends on your list and their status.%R[ansi(h,+watch/list)] - Will display your entire list\, even offline friends.%R[ansi(h,+watch/add <name>)] - Adds a player to your watch list.%R[ansi(h,+watch/del <name>)] - Removes a player from your watch list.%R[ansi(h,+watch/hide)] - Toggle whether your disconnects and connects will show to anyone who added you to their friends list.%R[ansi(h,+watch/mute)] - Toggle whether you will hear when friends connect or disconnect.[if(isdbref(u(cobj,accounts)),%BThis only affects the character it is used on.)])]
+help/add Community/+watch=[u(cobj,ams)]/HLP`+WATCH

@@ ************** WHO SECTION **************
&CMD`+WHO`PENNMUSH [u(cobj,ams)]=$^(?s)(?\:\+)?who(?\:/(\S+))?(?\: +(.+?))?$:@attach %!/CMD`+WHO`MAIN
@set [u(cobj,ams)]/CMD`+WHO`PENNMUSH=regexp
&CMD`+WHO`RHOSTMUSH [u(cobj,ams)]=$^(?s)(?\:\+)?who(?\:/(\\S+))?(?\: +(.+?))?$:@attach %!/CMD`+WHO`MAIN
@set [u(cobj,ams)]/CMD`+WHO`RHOSTMUSH=regexp
&CMD`+WHO`MAIN [u(cobj,ams)]=th u(setq,sysname,WHO);@attach %!/INC`GETSWITCH=%1;th u(setq,portable,u(u(cobj,grid)/FUN`LISTROOMS));@attach %!/INC`WHO`[u(strfirstof,%q<switch>,MAIN)]=%2
@set [u(cobj,ams)]/CMD`+WHO`[switch(%va,PennMUSH,RHOSTMUSH,RhostMUSH,PENNMUSH)]=no_command

&SWITCHES`WHO`PLAYER [u(cobj,ams)]=IDLE

&INC`WHO`MAIN [u(cobj,ams)]=@attach %!/INC`WHO`SORT`MAIN;@select/inline gt(strlen(%0),0)=1,{@attach %!/INC`WHO`SEARCH=%0};@attach %!/INC`WHO`LIST=,%0

&FUN`WHO`MAIN [u(cobj,ams)]=u(sortname,setunion(u(lwhoid,%#),))

&INC`WHO`SORT`MAIN [u(cobj,ams)]=@check words(u(setr,who,u(FUN`WHO`MAIN)))=@attach %!/INC`MSG=No players to show!

&INC`WHO`SEARCH [u(cobj,ams)]=@check words(u(setr,who,namegraball(%q<who>,%0)))=@attach %!/INC`MSG=Search for '%0' turned up with nothing.

&INC`WHO`IDLE [u(cobj,ams)]=@attach %!/INC`WHO`SORT`IDLE;@select/inline gt(strlen(%1),0)=1,{@attach %!/INC`WHO`SEARCH=%1};@attach %!/INC`WHO`LIST=Idle,%1
&INC`WHO`SORT`IDLE [u(cobj,ams)]=@check words(u(setr,who,revwords(u(sortidle,u(FUN`WHO`MAIN)))))=@attach %!/INC`MSG=No players to show!

&INC`WHO`LIST [u(cobj,ams)]=@pemit %#=u(HEADER,Who[if(strlen(%0),%b-%b%0)]);@attach %!/INC`WHO`HEADER`[strfirstof(%0,MAIN)];@pemit %#=u(separator);@dolist %q<who>={@pemit %#=u(FUN`WHO`PLAYERLINE`[strfirstof(%0,MAIN)],##);@select/inline eq(#@,words(%q<who>))=1,{&MAXPLAYERS %!=u(setr,max,max(get(%!/MAXPLAYERS),words(%q<who>)));@pemit %#=u(SUBHEADER,words(%q<who>) Characters[if(u(game_config,WHO,SHOW_IPS),%Bfrom [words(setunion(iter(%q<who>,get(%i0/LASTSITE),,|),,|),|)] IPs)]%BConnected - Record is %q<max>)}}

&CONFIG`WHO_HEADER [u(Cobj,ams)]=List of column names and widths in format of Text~Length. Like Name~20|Location~40. See +shelp +who.
&CONFIG`WHO_HEADER`DEFAULT [u(Cobj,ams)]=Name~20|Alias~11|Fac~3|Idle~4|Conn~4|G~1|Location~29
&CONFIG`WHO_HEADER`VALID [u(cobj,ams)]=LIST

&CONFIG`WHO_COLUMNS [u(Cobj,ams)]=List of Column GETPROPERTIES and widths in format of GET~Length. Check +shelp +who.
&CONFIG`WHO_COLUMNS`DEFAULT [u(cobj,ams)]=NAMELINK~20|ALIAS~11|MAJORABBR~3|HIDEIDLE~>4|HIDECONN~>4|SEXLETTER~1|LOCATION~29
&CONFIG`WHO_COLUMNS`VALID [u(cobj,ams)]=LIST

&CONFIG`WHO_IPS [u(cobj,ams)]=Display number of unique IPs connected to the game at the +who footer?
&CONFIG`WHO_IPS`DEFAULT [u(cobj,ams)]=1
&CONFIG`WHO_IPS`VALID [u(Cobj,ams)]=BOOL

&INC`WHO`HEADER`MAIN [u(cobj,ams)]=@pemit %#=ansi(u(color,%#,COLUMN_NAMES),lalign(iter(u(setr,hdr,u(conf,WHO_HEADER)),after(%i0,~),|,%b),iter(%q<hdr>,before(%i0,~),|,chr(177)),chr(177)))
&INC`WHO`HEADER`IDLE [u(cobj,ams)]=@attach %!/INC`WHO`HEADER`MAIN

&FUN`WHO`PLAYERLINE`MAIN [u(cobj,ams)]=lalign(iter(u(setr,col,u(conf,WHO_COLUMNS)),after(%i0,~),|,%b),iter(%q<col>,u(strfirstof,u(getproperty,%0,before(%i0,~)),get(%0/D`FINGER`[before(%i0,~)])),|,chr(177)),chr(177))
&FUN`WHO`PLAYERLINE`IDLE [u(cobj,ams)]=u(FUN`WHO`PLAYERLINE`MAIN,%0)

@@ &STARTUP [u(cobj,ams)]=@hook/override WHO=%!,CMD`+WHO

@@ COMMUNITY - WHO
+help/add +who=[u(cobj,ams)]/HLP`+WHO
+help/category +who=Community
+help/metatags +who=online players
&HLP`+WHO [u(cobj,ams)]=[ansi(hc,Commands)]%R[align(5 [sub(u(width,%#),6)],,[ansi(h,+who)] - Show all visible\, connected players.%R[ansi(h,+who/idle)] - Like above\, but sorts by idle times.%R%R[ansi(h,+who <text>)] - Search for online players starting with <text>.)]


@@ WHERE COMMAND

&CMD`+WHERE`PENNMUSH [u(cobj,ams)]=$^(?s)(?\:\+)?where(?\:/(\S+))?(?\: +(.+?))?$:@attach %!/CMD`+WHERE`MAIN
@set [u(cobj,ams)]/CMD`+WHERE`PENNMUSH=regexp
&CMD`+WHERE`RHOSTMUSH [u(cobj,ams)]=$^(?s)(?\:\+)?where(?\:/(\\S+))?(?\: +(.+?))?$:@attach %!/CMD`+WHERE`MAIN
@set [u(cobj,ams)]/CMD`+WHERE`RHOSTMUSH=regexp
&CMD`+WHERE`MAIN [u(cobj,ams)]=@attach %!/INC`GETSWITCH=%1;th u(setq,portable,u(u(cobj,grid)/FUN`LISTROOMS));@attach %!/INC`WHERE`[u(strfirstof,%q<switch>,MAIN)]=%2
@set [u(cobj,ams)]/CMD`+WHERE`[u(choosegame,RHOSTMUSH,PENNMUSH)]=no_command

&INC`WHERE`ROOMS [u(cobj,ams)]=@attach %!/INC`WHERE`MAIN=%0,1

&INC`WHERE`MAIN [u(cobj,ams)]=th u(setq,portable,u(u(cobj,grid)/FUN`LISTROOMS));@select/inline strlen(%0)=0,{@attach %!/INC`WHERE`ALL},{@attach %!/INC`WHERE`PLAYER}

&INC`WHERE`ALL [u(cobj,ams)]=@pemit %#=u(HEADER,Where);@pemit %#=ansi(u(color,%#,COLUMN_NAMES),align(25 1 [sub(u(width,%#),33)],Location,,Players));th u(setq,showic,0);th u(setq,showooc,0);th u(setq,ooc,u(filter,NOTIC,u(setr,where,u(sortname,setunion(iter(u(filter,FINDABLE,u(lwho,%#),%b,%b,%#),loc(%i0)),)))));th u(setq,ic,u(filter,IC,%q<where>));th u(setq,firstic,first(%q<ic>));th u(setq,firstooc,first(%q<ooc>));@dolist cat(%q<ooc>,%q<ic>)={@select/inline %i0=%q<firstic>,{@pemit %#=u(separator,IC)},%q<firstooc>,{@pemit %#=u(separator,OOC)};@select/inline gt(words(u(setr,show,u(filter,FINDABLE,u(lvplayers,##),%B,%B,%#))),0)=1,{@pemit %#=u(FUN`WHERELINE%1,##,%q<show>)};@select/inline eq(#@,words(%q<where>))=1,{@pemit %#=u(FOOTER)}}

&INC`WHERE`PLAYER [u(cobj,ams)]=@attach %!/INC`CHECKPC=%0,1;@check cand(conn(%q<t1>),not(u(ishidden,%q<t1>)))=@attach %!/INC`MSG=%q<t1name> is not online!;@check findable(%#,%q<t1>)=@attach %!/INC`MSG=%q<t1name> or their location is set UNFINDABLE.;@pemit %#=u(HEADER,%q<t1name> - Location: [if(match(%q<portable>,loc(%q<t1>)),u(pueblize,left(name(loc(%q<t1>)),sub(u(width,%#),49)),+port [loc(%q<t1>)]),left(name(loc(%q<t1>)),sub(u(width,%#),49)))]);@attach %!/INC`WHERE`HEADER`MAIN;@pemit %#=u(separator);@dolist/inline u(filter,FINDABLE,u(sortname,setinter(u(lwho,%#),lcon(loc(%q<t1>)))),%B,%B,%#)={@pemit %#=u(FUN`WHERELINE`PLAYER,##)};@pemit %#=u(subheader,if(not(strmatch(loc(%q<t1>),room(%q<t1>))),Room: [if(match(%q<portable>,room(%q<t1>)),u(pueblize,u(moniker,room(%q<t1>)),+port [room(%q<t1>)]),u(moniker,room(%q<t1>)))]))

&FIL`FINDABLE [u(cobj,ams)]=cor(findable(%1,%0),u(isadmin,%1))
&FIL`IC [u(cobj,ams)]=t(get(%0/D`IC))
&FIL`NOTIC [u(cobj,ams)]=not(get(%0/D`IC))

&FUN`WHERELINE [u(cobj,ams)]=align(25 1 [sub(u(width,%#),38)],if(match(%q<portable>,%0),u(pueblize,u(moniker,%0),+port %0),u(moniker,%0)),-,u(itemize,iter(u(sortname,u(filter,FINDABLE,u(lvplayers,%0),%b,%b,%#)),u(pueblize,u(moniker,%i0),+finger [name(%i0)])[if(hasflag(%i0,UNFINDABLE),\(Unfindable\))],,|),|,and,\,))

&INC`WHERE`HEADER`MAIN [u(cobj,ams)]=@pemit %#=ansi(u(color,%#,COLUMN_NAMES),lalign(iter(u(setr,hdr,u(game_config,WHERE,HEADER)),after(%i0,~),|,%b),iter(%q<hdr>,before(%i0,~),|,chr(177)),chr(177)))

&FUN`WHERELINE`PLAYER [u(cobj,ams)]=lalign(iter(u(setr,col,u(game_config,WHERE,COLUMNS)),after(%i0,~),|,%b),iter(%q<col>,u(strfirstof,u(getproperty,%0,before(%i0,~)),get(%0/D`FINGER`[before(%i0,~)])),|,chr(177)),chr(177))

th u(newconf,CONFIG,WHERE,HEADER,Name~20|Alias~11|Fac~3|Idle~4|Conn~4|G~1|Location~29,check +shelp +who,LIST)
th u(newconf,CONFIG,WHERE,COLUMNS,NAMELINK~20|ALIAS~11|MAJORABBR~3|HIDEIDLE~>4|HIDECONN~>4|SEXLETTER~1|LOCATION~29,Check +shelp +who,LIST)

&FUN`WHERELINE1 [u(cobj,ams)]=align(30 1 [sub(u(width,%#),33)],if(match(%q<portable>,%0),pueblize(name(%0),+port %0),name(%0))[if(not(strmatch(%0,room(%0))),%R(IN [if(match(%q<portable>,room(%0)),u(pueblize,name(room(%0)),+port [room(%0)]),name(room(%0)))]))],ansi(u(color,%#,BORDER),-),u(itemize,iter(u(sortname,u(filter,FINDABLE,u(lvplayers,%0))),u(pueblize,u(moniker,%i0),+finger [name(%i0)])[if(hasflag(%i0,UNFINDABLE),\(Unfindable\))],,|),|,and,\,))

+help/add +where=[u(cobj,ams)]/HLP`+WHERE
+help/category +where=Community
+help/metatags +where=online players
&HLP`+WHERE [u(cobj,ams)]=[ansi(hc,Commands)]%R[align(5 [sub(u(width,%#),6)],,[ansi(h,+where)] - Show all visible\, connected players by location.%R[ansi(h,+where <player>)] - See details about a specific player's location.)]

@@ ******* GUEST SECTION *******

&PLAYER`DISCONNECT`FIXNAME [u(cobj,guest)]=@stop %1;@check u(isguest,%0);@attach %!/INC`MSG`CHAN=[ansi(h,name(%0))] disconnected.,u(game_config,CHANNELS,JOIN_GUESTS),,1,,1;@select/inline hasattr(%0/D`OLDNAME)=1,{@name %0=[get(%0/D`OLDNAME)];@attach %!/WIPE=%0,D`OLDNAME}

&PLAYER`DISCONNECT`TELGUEST [u(cobj,guest)]=@stop %1;@select/inline u(isguest,%0)=1,{@select/inline %va=PennMUSH,{@tel/silent %0=u(game_config,NAVIGATION,GUEST_START,#0)},RhostMUSH,{@tel/quiet %0=u(game_config,NAVIGATION,GUEST_START,#0)}}

&PLAYER`CONNECT`GUEST [u(cobj,guest)]=@check u(isguest,%0);th u(setq,chan,first(u(setr,chans,u(game_config,CHANNELS,JOIN_GUESTS)),|));@wait 4=@attach %!/INC`MSG=Welcome to [mudname()]\, [name(%0)]! You can speak on the %q<chan> channel with [ansi(h,+[left(%q<chan>,1)] <text here>)]. You can give yourself a custom Guest name by typing [ansi(h,+myname <word>)] \(Guest will be appended after <word>\). You can find our website at [u(weblink,mudurl())],%0;@attach %!/INC`MSG`CHAN=[ansi(h,name(%0))] connected to [mudname()]!,%q<chans>,,1,,1

&CMD`+MYNAME [u(cobj,guest)]=$+myname *:@check u(isguest,%#)=@attach %!/INC`MSG=ERROR: Permission denied. Guest only!;@check valid(playername,%0 Guest)=@attach %!/INC`MSG=Sorry\, you may not rename yourself to that. Try something simpler.;@select/inline hasattr(%#/D`OLDNAME)=0,{&D`OLDNAME %#=[name(%#)]};@attach %!/INC`MSG`CHAN=[ansi(h,%n)] renamed to %0 Guest,u(game_config,CHANNELS,JOIN_GUESTS),,1,,1;@name %#=%0 Guest;@attach %!/INC`MSG=You are now known as '%0 Guest'.

&CMD`+MAKEGUEST [u(cobj,guest)]=$+makeguest *:@check u(iswizard,%#)=@attach %!/INC`MSG=ERROR: Permission denied.;@check valid(playername,%0)=@attach %!/INC`MSG=ERROR: That is not a valid character name.;@pcreate %0=guest;@attach %!/INC`CHECKPC=%0,1;@describe %q<t1>=This is a Guest! Be kind to them!;@dolist/inline/delimit | [u(game_config,channels,join_guests)]={@chan/on %i0=%q<t1>};@tel %q<t1>=[u(game_config,navigation,guest_start)];@select/inline %va=PennMUSH,{@set %q<t1>=!UNREGISTERED;@power %q<t1>=GUEST},RhostMUSH,{@set %q<t1>=GUEST;th u(setq,guests,search(EPLAYER=\[hasflag(##,GUEST)\]));@admin guest_namelist=!ALL %q<guests>};@attach %!/INC`MSG=Guest '%0' created!;@attach %!/INC`MSG`CHAN=Guest '%0' created!

&CMD`+LISTGUESTS [u(cobj,guest)]=$+listguests:@check words(u(setr,guests,u(choosegame,lsearch(all,type,player,elock,POWER^GUEST),search(FLAGS=!))))=@attach %!/INC`MSG=ERROR: No Guests in the system.;@pemit %#=u(header,mudname() Guests);@pemit %#=ansi(u(color,%#,COLOR,COLUMN_NAMES),align(7 18 26 24,DBREF,Name,Current Name,Alias));@pemit %#=u(separator);@dolist/inline %q<guests>={@pemit %#=align(7 18 26 24,##,default(##/D`OLDNAME,name(##)),name(##),u(fullalias,##))};@pemit %#=u(subheader)

@select/inline %va=RhostMUSH,{th u(setq,guests,search(EPLAYER=\[hasflag(##,GUEST)\]));@admin guest_namelist=!ALL %q<guests>}

&SHLP`GUESTS [u(cobj,guest)]=Guests are special characters that exist solely to allow new players to logon without creating a character. They're traditionally restricted to a single channel (typically a Guest channel, sometimes the public channel) and have no privileges to modify themselves or anything else.%R%R[ansi(hc,Staff Commands)]%R[align(5 [sub(u(width,%#),6)],,[ansi(h,+makeguest <name>)] - Creates a new guest. The NAVIGATION/GUEST_START and CHANNELS/JOIN_GUESTS +gameconfig options will be used and it will be given a basic @desc.%R[ansi(h,+listguests)] - Used to display existing guests and relevant info.)]
+shelp/add Administration/Guests=[u(cobj,guest)]/SHLP`GUESTS

&SHLP`PENNMUSH [u(cobj,ams)]=[ansi(hc,See Also:)] [u(pueblize,help CONTROL)], [u(pueblize,help WIZARD)], [u(pueblize,help ROYALTY)], [u(pueblize,help @set)], [u(pueblize,help @power)]%R%RStaff are characters able to use Admin commands. For this package anyone who is either WIZARD\, ROYALTY\, or on the +staff list is able to use admin commands\, but Penn's built-in commands use other standards.%R%RPennMUSH has 3 Staff tiers.%R%R1. The [ansi(hr,GOD)] (#1) is a special WIZARD capable of granting or removing the WIZARD flag to other characters. It can use @config/save and several other dangerous commands. Only login as #1 when truly necessary. Since even WIZARDS cannot control() it\, code objects cannot set attributes on #1 and it cannot use many softcoded systems properly.%R%R2. [ansi(hy,WIZARD)] flagged characters have command of everything in the game including dangerous commands such as @force (on players)\, @shutdown\, @hook\, and @config/set. It should be reserved for staff who absolutely need these privileges\, typically the coder(s) and owner. Some potentially dangerous softcoded commands are restricted to Wizard.%R%R3. [ansi(hc,ROYALTY)] have 'see but not touch' compared to WIZARDS - they have several implicit @powers like being able to @tel anywhere but can't change the game's code. This is a good flag for general staff.
&SHLP`RHOSTMUSH [u(cobj,ams)]=
+shelp/add Administration/Permissions=[u(cobj,ams)]/SHLP`%va

&SHLP`PMANAGE [u(cobj,ams)]=WIZARDS have a great deal of hardcoded control over players for security and management. Most of these commands can only be used by them.%R%R[align(5 [sub(width(%#),6)],,[ansi(h,@pcreate <name>=<password>)] - Creates a player.%R%R[ansi(h,@newpass *<name>=<newpassword>)] - Changes a password. the * is necessary for hardcoded command lookups.%R%R[ansi(h,@sitelock/ban/player <name>)] - Bans a player. Be very careful with this! Check [u(pueblize,ansi(h,help @sitelock),help @sitelock)] for more info.%R%R[ansi(h,@nuke *<name>)] - Deletes a character AND EVERYTHING THEY OWN\, which by default includes EVERYTHING THEY MADE. use [ansi(h,@search *<name>)] to see what that would be before you @nuke! use [ansi(h,@chown <dbref>=me)] to save objects.)]
+shelp/add Administration/Player Management=[u(cobj,ams)]/SHLP`PMANAGE